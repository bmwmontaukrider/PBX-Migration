#!KAMAILIO

# Minimal config for dispatcher migration testing in local lab.

listen=udp:0.0.0.0:5060

mpath="/usr/lib/kamailio/modules/"

loadmodule "tm.so"
loadmodule "sl.so"
loadmodule "rr.so"
loadmodule "maxfwd.so"
loadmodule "xlog.so"
loadmodule "pv.so"
loadmodule "ctl.so"
loadmodule "dispatcher.so"

modparam("ctl", "binrpc", "unix:/run/kamailio/kamailio_ctl")
modparam("dispatcher", "list_file", "/etc/kamailio/dispatcher.list")
modparam("dispatcher", "flags", 2)

request_route {
  if (!mf_process_maxfwd_header("10")) {
    sl_send_reply("483", "Too Many Hops");
    exit;
  }

  if (!ds_select_dst("1", "0")) {
    xlog("L_ERR", "No dispatcher destination available\n");
    sl_send_reply("500", "No destination");
    exit;
  }

  xlog("L_NOTICE", "CUTOVER_DST method=$rm ci=$ci du=$du ruri=$ru\n");

  if (!t_relay()) {
    sl_reply_error();
  }
  exit;
}
